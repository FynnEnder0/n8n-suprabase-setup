#!/bin/bash
# Hostinger-compatible deployment script
# This replaces docker-compose.yml for Git deployments while maintaining modularity

set -e

echo "ğŸš€ Starting modular deployment..."

# Ensure network exists
docker network create shared-network 2>/dev/null || echo "âœ“ Network exists"

# Create volume directories
mkdir -p volumes/n8n volumes/postgres volumes/storage volumes/api

echo "ğŸ“¦ Starting PostgreSQL..."
docker-compose -f docker-compose.postgres.yml up -d

echo "â³ Waiting for PostgreSQL..."
sleep 10
until docker exec shared-postgres pg_isready -U postgres 2>/dev/null; do
  echo -n "."
  sleep 2
done

echo ""
echo "ğŸ’¾ Creating databases..."
docker exec shared-postgres psql -U postgres -c "CREATE DATABASE n8n;" 2>/dev/null || echo "âœ“ n8n DB exists"
docker exec shared-postgres psql -U postgres -c "CREATE DATABASE supabase;" 2>/dev/null || echo "âœ“ supabase DB exists"

echo "ğŸ“Š Creating Supabase schemas..."
docker exec shared-postgres psql -U postgres -d supabase -c "CREATE SCHEMA IF NOT EXISTS auth;" 2>/dev/null || true
docker exec shared-postgres psql -U postgres -d supabase -c "CREATE SCHEMA IF NOT EXISTS storage;" 2>/dev/null || true
docker exec shared-postgres psql -U postgres -d supabase -c "CREATE SCHEMA IF NOT EXISTS realtime;" 2>/dev/null || true

echo "ğŸ”§ Starting Supabase services..."
docker-compose -f docker-compose.supabase.yml up -d

echo "âš™ï¸ Starting n8n..."
docker-compose -f docker-compose.n8n.yml up -d

echo ""
echo "âœ… Deployment complete!"
echo "ğŸŒ Access URLs:"
echo "   n8n:             http://${DOMAIN_NAME:-localhost}:5678"
echo "   Supabase Studio: http://${DOMAIN_NAME:-localhost}:3000"
echo "   Supabase API:    http://${DOMAIN_NAME:-localhost}:8000"
